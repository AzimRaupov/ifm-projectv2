<?php

namespace App\Helpers;

use App\Models\Course;
use App\Models\MatchingList1;
use App\Models\MatchingList2;
use App\Models\Step;
use App\Models\Test;
use App\Models\Variant;
use App\Models\VariantTrue;
use Illuminate\Support\Facades\Http;
use Orhanerday\OpenAi\OpenAi;

class GenerateRodmap
{
    public static function generateRodmap($req, $user)
    {
        $apiKey = env('GEMINI_API_KEY');
        $prompt = "–°–æ–∑–¥–∞–π –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä–æ–º—É ".$user->old." –ª–µ—Ç, –∏ –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —É–¥–µ–ª–∏—Ç—å ".$req->freetime." —á–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ. –¢–µ–º–∞ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è: '".$req->topic."'. –ú–æ–π —É—Ä–æ–≤–µ–Ω—å –∑–Ω–∞–Ω–∏—è '".$req->topic."' —Ä–∞–≤–µ–Ω '".$req->level."'

      –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–∞–Ω –±—ã—Ç—å ".$user->leng."!!

    –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∫ –∫—É—Ä—Å—É:
        1.topic_course={$req->topic} –º–æ–∂–µ—à —Ç–æ–ª—å–∫–æ –∏—Å–ø—Ä–æ–≤–ª—è—Ç—å –æ—Ç–ø–µ—á–∞—Ç–∫–∏

    –ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 12-30 —à–∞–≥–æ–≤, –≥–¥–µ:
    - –ö–∞–∂–¥—ã–π —à–∞–≥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
        1. –ö—Ä–∞—Ç–∫–æ–µ –∏ –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã —à–∞–≥–∞,—Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã!!!.
        2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø—ã—Ç–∞ experience;
        3. –ù–∞–≤—ã–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —á–µ–ª–æ–≤–µ–∫ –ø–æ–ª—É—á–∏—Ç (–º–∏–Ω–∏–º—É–º 7 –Ω–∞–≤—ã–∫–æ–≤, —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ –∏ –Ω—É–∂–Ω—ã–µ –Ω–∞–≤—ã–∫–∏, –±–µ–∑ –ª–∏—à–Ω–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏).
        4. –ï—Å—Ç—å –¥–≤–∞ —Ç–∏–ø–∞ —à–∞–≥–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª—å,–Ω–∞—Å–ª–µ–¥–Ω–∏–∫.
        5. –†–æ–¥–∏—Ç–µ–ª—å –∏–º–µ–∏—Ç –º–∞–∫—Å 4 –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∞,—Ä–æ–¥–∏—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç—å –±—ã—Ç—å –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–æ–º.
    –í–æ–∑–≤—Ä–∞—â–∞–π –ø–ª–∞–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:

    {
        'topic_course': '',
        'skills': ['–Ω–∞–≤—ã–∫1', '–Ω–∞–≤—ã–∫2', ..., '–Ω–∞–≤—ã–∫N'],  // –°–ø–∏—Å–æ–∫ –Ω–∞–≤—ã–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —á–µ–ª–æ–≤–µ–∫ –∏–∑—É—á–∏—Ç
        'map': [
            {
                'topic': '–¢–µ–º–∞ —à–∞–≥–∞ 1',
                'type':'parent' //–†–æ–¥–∏—Ç–µ–ª—å parent –∏ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫  heir
                'heirs':[] //ID –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–æ–≤ –Ω–∞—á–∏–Ω–∞—è —Å 0
                'experience': 10,  // –û–ø—ã—Ç –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —ç—Ç–æ–≥–æ —à–∞–≥–∞
            },
            {
                'topic': '–¢–µ–º–∞ —à–∞–≥–∞ 2',
                'type':'heir' //–†–æ–¥–∏—Ç–µ–ª—å parent –∏ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫  heir
                'experience': 15,
            },
            // –î–æ–±–∞–≤—å—Ç–µ —Å—Ç–æ–ª—å–∫–æ —à–∞–≥–æ–≤, —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ (–æ—Ç 12 –¥–æ 30)
        ]
    }

    –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–µ–º—ã —à–∞–≥–æ–≤ —è—Å–Ω—ã–µ –∏ –∫—Ä–∞—Ç–∫–∏–µ, –∞ –∫–∞–∂–¥—ã–π —à–∞–≥ –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º.";


        $url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={$apiKey}";

        try {
            $response = Http::withHeaders([
                'Content-Type' => 'application/json'
            ])->post($url, [
                'contents' => [[
                    'parts' => [['text' => $prompt]]
                ]]
            ]);

            if ($response->successful()) {
                $result = $response->json();

                $text = $result['candidates'][0]['content']['parts'][0]['text'] ?? null;
                if (!$text) {
                    return null;
                }
                $clean = str_replace(['```json', '```'], '', $text);
                $tests = json_decode(trim($clean), true);





                    return $tests;

            }

            // –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å –æ—à–∏–±–∫–∏ –æ—Ç API
            \Log::error('Gemini API error: ' . $response->status());
            return null;

        } catch (\Exception $e) {
            \Log::error('Gemini exception: ' . $e->getMessage());
            return null;
        }
    }

    public static function generateTests($step,$skills)
    {

        $pr=$step->course->step."/".count($step->course->steps);
        $apiKey = env('GEMINI_API_KEY1');

        $prompt = "–°–æ–∑–¥–∞–π 8 —Ç–µ—Å—Ç–æ–≤ –ø–æ —Ç–µ–º–µ '{$step->course->topic}' –¥–ª—è —à–∞–≥–∞ '{$step->title}'.

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç–µ—Å—Ç–∞–º:
1. **2 —Ç–µ—Å—Ç–∞ —Å –æ–¥–Ω–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º**
   - –í–æ–ø—Ä–æ—Å
   - 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
   - 1 –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç

2. **2 —Ç–µ—Å—Ç–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏**
   - –í–æ–ø—Ä–æ—Å
   - 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
   - 2 –∏–ª–∏ –±–æ–ª–µ–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞

3. **2 –≤–æ–ø—Ä–æ—Å–∞ —Å –æ—Ç–∫—Ä—ã—Ç—ã–º –æ—Ç–≤–µ—Ç–æ–º**
   - –í–æ–ø—Ä–æ—Å
   - –¢–µ–∫—Å—Ç–æ–≤—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
   - –ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –æ—Ç –¥–æ 10 —Å–∏–º–≤–æ–ª–æ–≤.

4. **2 —Ç–µ—Å—Ç–∞ —Å –≤–µ—Ä–Ω–æ/–Ω–µ–≤–µ—Ä–Ω–æ**
   - –í–æ–ø—Ä–æ—Å
   - 1 –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π,0 –Ω–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

5. **2 —Ç–µ—Å—Ç–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**
   - –í–æ–ø—Ä–æ—Å
   - –î–≤–µ –∫–æ–ª–æ–Ω–∫–∏ (–ª–µ–≤–∞—è ‚Äì —ç–ª–µ–º–µ–Ω—Ç—ã, –ø—Ä–∞–≤–∞—è ‚Äì —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–º —ç–ª–µ–º–µ–Ω—Ç—ã)
   - –í –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ!!!

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:
- –£–∫–∞–∂–∏, –∫ –∫–∞–∫–æ–º—É –Ω–∞–≤—ã–∫—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç (–∏–∑ —Å–ø–∏—Å–∫–∞: [$skills]).
- –ü—Ä–∏—Å–≤–æ–π –∫–∞–∂–¥–æ–º—É —Ç–µ—Å—Ç—É –±–∞–ª–ª—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.
- –£ –º–µ–Ω—è {$step->course->ex} –±–∞–ª–ª–æ–≤ –∏–∑ 1000.
- –í –∏—Ç–æ–≥–µ 10 —Ç–µ—Å—Ç–æ–≤!!!

### –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (JSON):
```json
[
  {
    \"one_correct\": {
      \"text\": \"–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞\",
      \"variants\": [\"–í–∞—Ä–∏–∞–Ω—Ç 1\", \"–í–∞—Ä–∏–∞–Ω—Ç 2\", \"–í–∞—Ä–∏–∞–Ω—Ç 3\", \"–í–∞—Ä–∏–∞–Ω—Ç 4\"],
      \"correct\": 1,
      \"score\": 10,
      \"id_skill\": 2
    },
    \"list_correct\": {
      \"text\": \"–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞\",
      \"variants\": [\"–í–∞—Ä–∏–∞–Ω—Ç 1\", \"–í–∞—Ä–∏–∞–Ω—Ç 2\", \"–í–∞—Ä–∏–∞–Ω—Ç 3\", \"–í–∞—Ä–∏–∞–Ω—Ç 4\"],
      \"correct\": [0, 2],
      \"score\": 15,
      \"id_skill\": 3
    },
    \"question_answer\": {
      \"text\": \"–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞\",
      \"correct\": \"–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç\",
      \"score\": 20,
      \"id_skill\": 1
    },
     \"true_false\": {
      \"text\": \"–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞\",
      \"correct\": \"1 –∏–ª–∏ 0\",
      \"score\": 20,
      \"id_skill\": 1
    },
    \"matching\": {
      \"text\": \"–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞\",
      \"list1\": [\"–≠–ª–µ–º–µ–Ω—Ç 1\", \"–≠–ª–µ–º–µ–Ω—Ç 2\", \"–≠–ª–µ–º–µ–Ω—Ç 3\"],
      \"list2\": [\"–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ 1\", \"–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ 2\", \"–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ 3\"],
      \"score\": 25,
      \"id_skill\": 4
    }
  }
]";


        $url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={$apiKey}";

        try {

            $response = Http::withHeaders([
                'Content-Type' => 'application/json'
            ])->post($url, [
                'contents' => [
                    [
                        'parts' => [
                            ['text' => $prompt]
                        ]
                    ]
                ]
            ]);


            if ($response->successful()) {
                $result = $response->json();
                $text=$result['candidates'][0]['content']['parts'][0]['text'];
                $clean = str_replace(['```json', '```'], '', $text);
                $tests = json_decode(trim($clean),true);
                $create_data=[];
                $insert_variant=[];
                $insert_correct=[];
                $insert_list1=[];
                $insert_list2=[];
                foreach ($tests as $item) {
                    $type = key($item);
                    $test = $item[$type];



                    $create_data= [
                        'course_id' => $step->course_id,
                        'step_id' => $step->id,
                        'skill_id' => $test['id_skill'],
                        'text' => $test['text'],
                        'type_test' => $type,
                        'score' => $test['score']
                    ];
                    $result_create=Test::query()->create($create_data);
                    $create_data=[];


                    if($type=="one_correct"){
                        $insert_correct[]=[
                            "test_id"=>$result_create->id,
                            "true"=>$test['correct']
                        ];
                        foreach ($test['variants'] as $vr){
                            $insert_variant[]=[
                                'test_id'=>$result_create->id,
                                'variant'=>$vr
                            ];
                        }
                    }

                    if($type=="list_correct"){
                        foreach ($test['correct'] as $tr){
                            $insert_correct[]=[
                                'test_id'=>$result_create->id,
                                'true'=>$tr
                            ];
                        }

                        foreach ($test['variants'] as $vr){
                            $insert_variant[]=[
                                'test_id'=>$result_create->id,
                                'variant'=>$vr
                            ];
                        }
                    }
                    if($type=="question_answer"){
                        $insert_correct[]=[
                            'test_id'=>$result_create->id,
                            'true'=>$test['correct']
                        ];
                    }
                    if($type=="true_false"){
                        $insert_correct[]=[
                            'test_id'=>$result_create->id,
                             'true'=>$test['correct']
                        ];
                    }
                    if($type=="matching"){

                        foreach ($test['list1'] as $list1){
                            $insert_list1[]=[
                                'test_id'=>$result_create->id,
                                'str'=>$list1
                            ];
                        }
                        foreach ($test['list2'] as $list2){
                            $insert_list2[]=[
                                'test_id'=>$result_create->id,
                                'str'=>$list2
                            ];
                        }
                    }
                }
                MatchingList1::query()->insert($insert_list1);
                MatchingList2::query()->insert($insert_list2);
                Variant::query()->insert($insert_variant);
                VariantTrue::query()->insert($insert_correct);
                return "d";

            }

            return response()->json(['error' => '–û—à–∏–±–∫–∞ API'], $response->status());

        } catch (\Exception $e) {
            return response()->json(['error' => $e->getMessage()], 500);
        }

    }
    static public function generateVocabulary($step)
    {
        $apiKey = env('GEMINI_API_KEY1');

        $prompt = "–Ø –∏–∑—É—á–∞—é '{$step->course->topic}' –≤ —à–∞–≥–µ '{$step->title}'. –†–∞–∑–¥–µ–ª–∏ —à–∞–≥ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥—à–∞–≥–æ–≤ –±–µ–∑ –ª–∏—à–Ω–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ–¥—à–∞–≥–∞–º:
1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥—à–∞–≥–∞
2. –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTML ‚Äî **—Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–∞ <body>**, –±–µ–∑ —Å–∞–º–æ–≥–æ —Ç–µ–≥–∞ <body> –∏ –±–µ–∑ —Ç–µ–≥–∞ <html>.
3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—à–∞–≥–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —à–∞–≥–∞.
4. –ù–µ—Å–∫–æ–ª—å–∫–æ —Å—Å—ã–ª–æ–∫ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –ø–æ–¥—à–∞–≥–∞.

### –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (JSON):
[
    {
        \"title\": \"—Å—Ç—Ä–æ–∫–∞\",
        \"info\": \"HTML-–∫–æ–¥, —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–Ω—É—Ç—Ä–∏ <body>, –±–µ–∑ <body> –∏ <html>\",
        \"links\": [
            \"/\",
            \"/\",
            \"/\"
        ]
    }
]

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–π –ø–æ–ª–Ω—ã–π HTML-–¥–æ–∫—É–º–µ–Ω—Ç, —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–≥–∞ <body>.
";

        // URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
        $url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={$apiKey}";

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
            $response = Http::withHeaders([
                'Content-Type' => 'application/json'
            ])->post($url, [
                'contents' => [
                    [
                        'parts' => [
                            ['text' => $prompt]
                        ]
                    ]
                ]
            ]);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
            if ($response->successful()) {
                $result = $response->json();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                if (isset($result['candidates'][0]['content']['parts'][0]['text'])) {
                    $text = $result['candidates'][0]['content']['parts'][0]['text'];

                    // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    $clean = str_replace(['```json', '```'], '', $text);
                    $roadmap = trim($clean);

                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π JSON
                    return json_decode($roadmap, true);
                }

                // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
                return response()->json(['error' => '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ—Ç–≤–µ—Ç–µ API'], 400);
            }

            // –ï—Å–ª–∏ API –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É, –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É
            return response()->json(['error' => '–û—à–∏–±–∫–∞ API', 'status' => $response->status(), 'message' => $response->body()], $response->status());

        } catch (\Exception $e) {
            // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
            return response()->json(['error' => '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ API: ' . $e->getMessage()], 500);
        }
    }

    static public function generateDescriptionn($req, $user)
    {
        $open_ai_key = env('OPENAI_API_KEY');
        $open_ai = new OpenAi($open_ai_key);
        $prompt = "
–°–æ–∑–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è –ø–æ —Ç–µ–º–µ: '{$req->topic}'.

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
- –í–æ–∑—Ä–∞—Å—Ç: {$user->old}
- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞: {$user->leng}
- –£—Ä–æ–≤–µ–Ω—å –∑–Ω–∞–Ω–∏–π –≤ —Ç–µ–º–µ '{$req->topic}': {$req->level}

üîπ **–£—Å–ª–æ–≤–∏—è**:
1. –ö—É—Ä—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω—ã–º –∏ –ª–æ–≥–∏—á–Ω—ã–º, —á—Ç–æ–±—ã —á–µ–ª–æ–≤–µ–∫ –º–æ–≥ –æ—Å–≤–æ–∏—Ç—å —Ç–µ–º—É —Å —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è –∑–Ω–∞–Ω–∏–π.
2. –ï—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å:
   - **'beginner'** ‚Äî –Ω–∞—á–∏–Ω–∞–π —Å –æ—Å–Ω–æ–≤, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –Ω–∞–ø—Ä—è–º—É—é —Å–≤—è–∑–∞–Ω—ã —Å —Ç–µ–º–æ–π –∏ –≤—Å–µ –¥—Ä—É–≥–∏–µ —à–∞–≥–∏.
   - **'intermediate'** ‚Äî –ù–∞—á–Ω–∏ —Å —Ç–µ–º—ã –∏ –¥–æ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–∞.
   - **'advanced'** ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Å–∞–º–æ–π —Ç–µ–º–µ, —É–≥–ª—É–±–ª—ë–Ω–Ω—ã–º –≤ —Ç–µ–º–µ—É.
4. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤:
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è: —á–µ–º –∏—Ö –±–æ–ª—å—à–µ, —Ç–µ–º –ª—É—á—à–µ –¥–ª—è —É—Å–≤–æ–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞.
   - –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —à–∞–≥ –ª—É—á—à–µ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥—à–∞–≥–æ–≤, —á—Ç–æ–±—ã –º–∞—Ç–µ—Ä–∏–∞–ª –±—ã–ª–æ –ø—Ä–æ—â–µ –∏–∑—É—á–∞—Ç—å.

üîπ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —à–∞–≥–æ–≤**:
- –ö–∞–∂–¥—ã–π —à–∞–≥ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å:
  - `topic`: –∫—Ä–∞—Ç–∫–æ–µ –∏ –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.
  - `type`: `'parent'` –∏–ª–∏ `'heir'`
  - `experience`: —á–∏—Å–ª–æ, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å **100**, —Å —à–∞–≥–æ–º +10.
  - –ï—Å–ª–∏ `type = 'parent'`, —Ç–æ `heirs`: –º–∞—Å—Å–∏–≤ ID –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–æ–≤ (–¥–æ 4).
  - `skills`: 7‚Äì12 –Ω—É–∂–Ω—ã—Ö –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –≤ —ç—Ç–æ–º —à–∞–≥–µ.

‚ö† –†–æ–¥–∏—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–æ–º. –ù–∞—Å–ª–µ–¥–Ω–∏–∫ –Ω–µ –∏–º–µ–µ—Ç —Å–≤–æ–∏—Ö heirs.

üîπ **–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ ‚Äî —Å—Ç—Ä–æ–≥–æ JSON**. –ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –±–µ–∑ markdown. –ü—Ä–∏–º–µ—Ä:

{
  \"topic_course\": \"Laravel\",
  \"skills\": [\"–Ω–∞–≤—ã–∫1\", \"–Ω–∞–≤—ã–∫2\", ..., \"–Ω–∞–≤—ã–∫N\"],
  \"map\": [
    {
      \"topic\": \"HTML –±–∞–∑–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å\",
      \"type\": \"parent\",
      \"experience\": 100,
      \"heirs\": [1, 2]
    },
    {
      \"topic\": \"HTML —Ñ–æ—Ä–º—ã –∏ —Ç–∞–±–ª–∏—Ü—ã\",
      \"type\": \"heir\",
      \"experience\": 110,
      \"skip\":0
    },
    ...
  ]
}

üìå –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞, JSON –±–µ–∑ –æ—à–∏–±–æ–∫, –∫–∞–≤—ã—á–∫–∏ ‚Äî –¥–≤–æ–π–Ω—ã–µ.
üìå –ù–µ –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –≤–Ω–µ JSON.
";
        $chat = $open_ai->chat([
            'model' => 'gpt-4o',
            'messages' => [
                [
                    "role" => "system",
                    "content" => "–¢—ã –æ–±—É—á–∞—é—â–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞.–°–æ–∑–¥–∞–π –¥–∞—Ä–æ–∂–Ω—É—é –∫–∞—Ä—Ç—É"
                ],
                ['role' => 'user', 'content' => $prompt],

            ],
            'temperature' => 1.0,
            'max_tokens' => 4000,
            'frequency_penalty' => 0,
            'presence_penalty' => 0,
        ]);

        //  return response()->json($chat);

        $text=json_decode($chat,true)['choices'][0]['message']['content'];
        $clean = str_replace(['```json', '```'], '', $text);
        $decoded = json_decode($clean, true);

        if (json_last_error() === JSON_ERROR_NONE && isset($decoded['map'])) {
            return $decoded;
        }

        // –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—è—Ç—ã–µ –∏–ª–∏ –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
        $clean = preg_replace('/,\s*}/', '}', $clean);
        $clean = preg_replace('/,\s*]/', ']', $clean);

        $decoded = json_decode($clean, true);

        if (json_last_error() === JSON_ERROR_NONE && isset($decoded['map'])) {
            return $decoded;
        }

    }
    function pr()
    {
        $pr='–°–æ–∑–¥–∞–π –ø–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞ "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è–∏ –∏—Ç—Ç–∏–ª–æ–æ—Ç–∏" –Ω–∞ —Ç–∞–¥–∂–∏–∫—Å–∫–æ–º —è–∑—ã–∫–µ. –ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞–∑–¥–µ–ª—ã:

1. **–ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è**: –£–∫–∞–∂–∏, —á—Ç–æ —É—á–µ–Ω–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –∑–Ω–∞—Ç—å –∏ —É–º–µ—Ç—å –ø–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è —Ç–µ–º—ã.
2. **–¶–µ–ª–∏ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è**: –û–ø–∏—à–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏ —É—Ä–æ–∫–∞ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∑–Ω–∞–Ω–∏—è–º —É—á–µ–Ω–∏–∫–æ–≤.
3. **–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ**: –ü–µ—Ä–µ—á–∏—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —É—Ä–æ–∫–∞.
4. **–í–æ–ø—Ä–æ—Å—ã**: –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç —É—á–µ–Ω–∏–∫–∞–º –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å —Ç–µ–º—É.
5. **–ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è**: –û–ø–∏—à–∏ –º–µ—Ç–æ–¥—ã –∏ –ø–æ–¥—Ö–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —É—Ä–æ–∫–∞.
6. **–ò—Ç–æ–≥ —É—Ä–æ–∫–∞**: –£–∫–∞–∂–∏, –∫–∞–∫ –±—É–¥–µ—Ç –æ—Ü–µ–Ω–∏–≤–∞—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç—å —É—Ä–æ–∫–∞ –∏ —á—Ç–æ —É—á–µ–Ω–∏–∫–∏ –¥–æ–ª–∂–Ω—ã —É—Å–≤–æ–∏—Ç—å.
7. **–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ**: –ü—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞.

–û—Ç–≤–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –≥–¥–µ –∫–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –±—É–¥–µ—Ç –∫–ª—é—á–æ–º –æ–±—ä–µ–∫—Ç–∞.

{
  "–ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è": "–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ —É—á–µ–Ω–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –∑–Ω–∞—Ç—å –∏ —É–º–µ—Ç—å.",
  "–¶–µ–ª–∏ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è": "–ü–µ—Ä–µ—á–µ–Ω—å —Ü–µ–ª–µ–π –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –∑–Ω–∞–Ω–∏—è–º —É—á–µ–Ω–∏–∫–æ–≤.",
  "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ": ["–°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤."],
  "–í–æ–ø—Ä–æ—Å—ã": ["–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è."],
  "–ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è": "–û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ –∏ –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—é —É—Ä–æ–∫–∞.",
  "–ò—Ç–æ–≥ —É—Ä–æ–∫–∞": "–û—Ü–µ–Ω–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ —É—Ä–æ–∫–∞ –∏ –∫–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã.",
  "–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ": "–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤."
}


';

    }
    static public function generateDescription($step)
    {
        $apiKey = env('GEMINI_API_KEY');

        $promt=' –°–æ–∑–¥–∞–π –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ç–µ–º—É "' . $step->course->topic . '" —à–∞–≥ "' . $step->title . '" –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTML.
                –¢–∞–∫–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –º–∏–Ω–∏–º—É–º 5 –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∏ “õ“∑–ª–∫–∏ –Ω–∞ –≤–∏–¥–µ–æ —É—Ä–æ–∫–∏.

                ### –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (JSON):
                ```json
                {
                    "info": {
                        "description": "HTML-–æ–ø–∏—Å–∞–Ω–∏–µ —à–∞–≥–∞",
                        "links": [
                            "https://example.com",
                            "https://example.com",
                            "https://example.com",
                            "https://example.com",
                            "https://example.com"
                        ]
                    }
                }
                ```
                –£–±–µ–¥–∏—Å—å, —á—Ç–æ –æ—Ç–≤–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ JSON.

          ';

        $url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={$apiKey}";

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
            $response = Http::withHeaders([
                'Content-Type' => 'application/json'
            ])->post($url, [
                'contents' => [
                    [
                        'parts' => [
                            ['text' => $promt]
                        ]
                    ]
                ]
            ]);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
            if ($response->successful()) {
                $result = $response->json();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                if (isset($result['candidates'][0]['content']['parts'][0]['text'])) {
                    $text = $result['candidates'][0]['content']['parts'][0]['text'];

                    // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    $clean = str_replace(['```json', '```'], '', $text);
                    $roadmap = trim($clean);

                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π JSON
                    return json_decode($roadmap, true);
                }

                // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
                return response()->json(['error' => '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ—Ç–≤–µ—Ç–µ API'], 400);
            }

            // –ï—Å–ª–∏ API –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É, –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É
            return response()->json(['error' => '–û—à–∏–±–∫–∞ API', 'status' => $response->status(), 'message' => $response->body()], $response->status());

        } catch (\Exception $e) {
            // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
            return response()->json(['error' => '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ API: ' . $e->getMessage()], 500);
        }
    }
}
